<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <!-- <link href='./node_modules/fullcalendar/main.css' rel='stylesheet' />
    <script src='./node_modules/fullcalendar/main.js'></script> -->
    <h1> 
        AutoCalender
        <img id="logoutIcon" src="../img/logoutIcon.png">
    </h1>

    <script type='module' src='../dist/index.global.js'></script>
    
    <script src="../js/data_send.js">
    </script>
    <style>
        body {
            margin: 40px 10px;
            padding: 0;
            font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
            font-size: 14px;
        }

        #logoutIcon {
            float: right;
        }

        #calendar {
            max-width: 1100px;
            margin: 0 auto;
        }

        #task {
            max-width: 1100px;
            float: inline-end;
            margin: 10;
        }

        #addIcon {
            max-width: 1100px;
            float: inline-end;
            margin: 10;
        }
    </style>
</head>

<body>
    <div id='calendar'></div>
    <div id="task">
        <h3>
            <img id="addIcon" src="../img/addIcon.png" onclick="location.href = 'add_task.html'">
            タスクの追加
        </h3>
    </div>

    <br>
    <br>
    予定の追加<br>
    タイトル
    <input id="Plan_title" type="text"></input><br>
    開始日時
    <input id="Plan_startdate" type="date"></input>
    <input id="Plan_starttime" type="time" step="900"></input>
    <br>
    終了日時
    <input id="Plan_enddate" type="date"></input>
    <input id="Plan_endtime" type="time" step="900"></input>
    <br>
    <button id="Plan_add"> 追加 </button><br><br>
    ToDoの追加<br>
    タイトル
    <input id="Todo_title" type="text"></input><br>
    締め切り
    <input id="Todo_date" type="date"></input>
    <input id="Todo_time" type="time" step="900"></input>
    <br>
    推定予定時間
    <input id="Todo_len" type="time" step="900"></input>
    <br>
    優先度
    <select id="Todo_priority">
        <option value="0"> 1 </option>
        <option value="1"> 2 </option>
        <option value="2" selected="selected"> 3 </option>
        <option value="3"> 4 </option>
        <option value="4"> 5 </option>
    </select><br>
    <button id="Todo_add"> 追加 </button>
    <br/>
    <br/>

    <script>
        let plan = {
            title: document.getElementById("Plan_title"),
            date_start: document.getElementById("Plan_startdate"),
            time_start: document.getElementById("Plan_starttime"),
            date_end: document.getElementById("Plan_enddate"),
            time_end: document.getElementById("Plan_endtime"),
        }
        let todo = {
            title: document.getElementById("Todo_title"),
            date: document.getElementById("Todo_date"),
            time: document.getElementById("Todo_time"),
            len: document.getElementById("Todo_len"),
            priority: document.getElementById("Todo_priority"),
        }

        let add_plan = document.getElementById("Plan_add");
        let add_todo = document.getElementById("Todo_add");

        add_plan.addEventListener("click", function (e) {
            if (plan.title.value == "") {
                alert("タイトルを入力してください");
            }
            else if (plan.date_start.value == "") {
                alert("開始日を入力してください");
            }
            else if (plan.date_end.value == "") {
                alert("終了日を入力してください");
            }
            else if (plan.time_start.value == "") {
                alert("開始時間を入力してください");
            }
            else if (plan.time_end.value == "") {
                alert("終了時間を入力してください");
            }
            else if((plan.date_end.value < plan.date_start.value) || ((plan.date_end.value == plan.date_start.value) && (plan.time_end.value < plan.time_start.value))){
                alert("終了日時は開始日時よりも後にしてください");
            }
            else {
                let events = calendar.getEvents();
                const time_start = new Date(plan.date_start.value.substr(0, 4), (plan.date_start.value.substr(5, 2) - 1), plan.date_start.value.substr(8, 2), plan.time_start.value.substr(0, 2), plan.time_start.value.substr(3, 2));
                const time_end = new Date(plan.date_end.value.substr(0, 4), (plan.date_end.value.substr(5, 2) - 1), plan.date_end.value.substr(8, 2), plan.time_end.value.substr(0, 2), plan.time_end.value.substr(3, 2));
                let flag = 0;
                for (let i = 0; i < events.length; i++) {
                    if ((time_start >= events[i].start && time_start < events[i].end) || (time_end > events[i].start && time_end <= events[i].end) || (time_start >= events[i].start && time_end <= events[i].end)) {
                        flag = 1;
                        break;
                    }
                }
                if(flag == 0){ //イベントの重複がなかったら
                    calendar.addEvent(
                        {
                            title: plan.title.value,
                            start: plan.date_start.value + 'T' + plan.time_start.value,
                            end: plan.date_end.value + 'T' + plan.time_end.value,
                            editable: false,
                            overlap: false
                        }
                    )
                }
                else {
                    if (window.confirm("他のイベントと一部重複していますが、イベントを追加しますか？")) {
                        calendar.addEvent(
                            {
                                title: plan.title.value,
                                start: plan.date_start.value + 'T' + plan.time_start.value,
                                end: plan.date_end.value + 'T' + plan.time_end.value,
                                editable: false,
                                overlap: false
                            }
                        )
                    }
                }
            }
        })
        add_todo.addEventListener("click", function (e) {
            if (todo.title.value == "") {
                alert("タイトルを入力してください");
            }
            else if (todo.date.value == "") {
                alert("締め切り日を入力してください");
            }
            else if (todo.time.value == "") {
                alert("締め切り時間を入力してください");
            }
            else if (todo.len.value == "") {
                alert("予想時間を入力してください");
            }
            else if (todo.priority.value == "") {
                alert("優先度を入力してください");
            }
            else {
                const events = calendar.getEvents();
                //開始時間の昇順
                events.sort((a,b) => a.start - b.start);
                let time_start = new Date(GetDate.Year, (GetDate.Month - 1), GetDate.Date, GetDate.Hour);
                time_start.setHours(time_start.getHours() + 1);
                let time_end = new Date(GetDate.Year, (GetDate.Month - 1), GetDate.Date, GetDate.Hour);
                time_end.setHours(time_end.getHours() + Number((todo.len.value.substr(0, 2))));
                time_end.setMinutes(time_end.getMinutes() + Number(todo.len.value.substr(3, 2)));
                const deadline = new Date(todo.date.value.substr(0, 4), (Number(todo.date.value.substr(5, 2)) - 1), todo.date.value.substr(8, 2), todo.time.value.substr(0, 2), todo.time.value.substr(3, 2));
                if (time_start >= deadline) {
                    alert("締め切り時間は今よりも後にしてください");
                }
                else {
                // 現段階のプログラムでは優先度にかかわらず、今の時間から締め切りまでにTodoを入れれたら入れるという感じ
                    while(1){
                        let flag = 0;
                        for (let i = 0; i < events.length; i++) {
                            if((time_start >= events[i].start && time_start < events[i].end) || (time_end > events[i].start && time_end <= events[i].end) || (time_start >= events[i].start && time_end <= events[i].end)){
                                flag = 1;
                                time_start = events[i].end;
                                time_end = events[i].end;
                                time_end.setHours(time_end.getHours() + Number((todo.len.value.substr(0, 2))));
                                time_end.setMinutes(time_end.getMinutes() + Number(todo.len.value.substr(3, 2)));
                                break;
                            }
                        }
                        if(flag == 0){
                            break;
                        }
                        if(time_start >= deadline){
                            break;
                        }
                    }
                    if(time_start >= deadline){
                        alert("締め切りまで忙しく、Todoを入れることができませんでした。")
                    }
                    else {
                        calendar.addEvent(
                            {
                                title: todo.title.value,
                                start: time_start,
                                end: time_end,
                                editable: true,
                                overlap: false
                            }
                        )
                    }
                }
            }
        })

    </script>
</body>

</html>